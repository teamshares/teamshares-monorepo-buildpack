#!/usr/bin/env bash

set -e

BUILD_DIR=${1:-}
CACHE_DIR=${2:-}
ENV_DIR=${3:-}
BP_DIR=$(cd "$(dirname "${0:-}")"; cd ..; pwd)

# Path to the directory we'll be promoting to root
APP_SUBDIR=$(cat $ENV_DIR/APP_SUBDIR)
APP_BUILD_DIR="${BUILD_DIR}/${APP_SUBDIR}"


log_header() {
  echo "----->" $*
}

indent() {
  sed -u 's/^/       /'
}

log() {
  echo $* | indent
}

move_file () {
  if [[ -f "${BUILD_DIR}/$1" ]]; then
    cp "${BUILD_DIR}/$1" "${APP_BUILD_DIR}/$1"
    log "Copied ${BUILD_DIR}/$1 to ${APP_BUILD_DIR}/$1 successfully"
  else
    log "MISSING $1 in ${BUILD_DIR}"
  fi
}

update_references () {
  sed -i -e "s|../teamshares_packages|./teamshares_packages|g" "${APP_BUILD_DIR}/$1"
  log "Updated references in $1 successfully"
}

log_header "Rewriting package references in anticipation of promoting $APP_SUBDIR to the app root"

# Unfortunately OS requires custom app.json to build review apps successfully
if [ "$APP_SUBDIR" == "os" ]; then
  rm "${BUILD_DIR}/app.json"
  mv "${BUILD_DIR}/app.os.json" "${BUILD_DIR}/app.json"
fi

move_file "app.json"  # Copy app.json over to maintain review app configurations
move_file "yarn.lock" # Not sure about this one -- move over yarn.lock

# Move teamshares_packages from ../ to ./ (from build dir)
if [[ -d "${BUILD_DIR}/teamshares_packages" ]]; then
  cp -r "${BUILD_DIR}/teamshares_packages" "${APP_BUILD_DIR}/teamshares_packages"
  log "Copied ${BUILD_DIR}/teamshares_packages to ${APP_BUILD_DIR}/teamshares_packages successfully"
else
  log "MISSING teamshares_packages -- are you sure you're in the right repo?"
  exit 1
fi

# Now update all the referencing files
echo ""
update_references "Gemfile"       # gem "teamshares_rails", path: "../teamshares_packages/teamshares_rails"
update_references "Gemfile.lock"  # remote: ../teamshares_packages/teamshares_rails
update_references "package.json"  # "@teamshares/ui": "file:../teamshares_packages/ui",
echo ""

# Originally based on https://github.com/timanovsky/subdir-heroku-buildpack, decided to inline (and clean up logging a bit) given
# the README's "Disclaimer: I may change the code without notice, so always pin to specific github version. Provided as is."
log_header "Restructuring build dir to promote $APP_SUBDIR to app root"

log "Creating temp dir $TMP_DIR"
mkdir -p $CACHE_DIR
TMP_DIR=`mktemp -d $CACHE_DIR/build_dir_XXXXX`

log "Copying ${APP_BUILD_DIR} to temp dir"
cp -R $APP_BUILD_DIR/. $TMP_DIR/

log "Promoting temp dir to root"
rm -rf $BUILD_DIR/*
cp -R $TMP_DIR/. $BUILD_DIR/
rm -rf $TMP_DIR

log_header "Done!"
echo ""
