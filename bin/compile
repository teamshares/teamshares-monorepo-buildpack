#!/usr/bin/env bash

set -e

BUILD_DIR=${1:-}
CACHE_DIR=${2:-}
ENV_DIR=${3:-}
BP_DIR=$(cd "$(dirname "${0:-}")"; cd ..; pwd)

log_header() {
  echo "-----> " $*
}

indent() {
  sed -u 's/^/       /'
}

log() {
  echo $* | indent
}

# Re-exporting APP_SUBDIR as PROJECT_PATH for downstream https://github.com/timanovsky/subdir-heroku-buildpack
export PROJECT_PATH="$(cat $ENV_DIR/APP_SUBDIR)"
echo "export PROJECT_PATH=\"${PROJECT_PATH}\"" >> "./export"

if [ -w "$BP_DIR" ]; then
  echo "export PROJECT_PATH=\"${PROJECT_PATH}\"" >> "${BP_DIR}/export"
fi

echo "New export file in ${BP_DIR}:"
cat "${BP_DIR}/export"
echo ""

APP_DIR="${BUILD_DIR}/${PROJECT_PATH}"

log_header "Rewriting package references in anticipation of downstream buildpack promoting $APP_DIR to the app root"

# Copy app.json over to maintain review app configurations
if [[ -f "${BUILD_DIR}/app.json" ]]; then
  cp "${BUILD_DIR}/app.json" "${APP_DIR}/app.json"
  log "Copied ${BUILD_DIR}/app.json to ${APP_DIR}/app.json successfully"
fi

# Move teamshares_packages from ../ to ./ (from build dir)
if [[ -d "${BUILD_DIR}/teamshares_packages" ]]; then
  cp -r "${BUILD_DIR}/teamshares_packages" "${APP_DIR}/teamshares_packages"
  log "Copied ${BUILD_DIR}/teamshares_packages to ${APP_DIR}/teamshares_packages successfully"
else
  log "MISSING teamshares_packages -- are you sure you're in the right repo?"
  exit 1
fi

update_references () {
  sed -i -e "s|../teamshares_packages|./teamshares_packages|g" "${APP_DIR}/$1"
  log "Updated references in $1 successfully"
}

echo ""
update_references "Gemfile"       # gem "teamshares_rails", path: "../teamshares_packages/teamshares_rails"
update_references "Gemfile.lock"  # remote: ../teamshares_packages/teamshares_rails
update_references "package.json"  # "@teamshares/ui": "file:../teamshares_packages/ui",

