#!/usr/bin/env bash

set -e

BUILD_DIR=${1:-}
CACHE_DIR=${2:-}
ENV_DIR=${3:-}

indent() {
  sed -u 's/^/       /'
}

# Re-exporting APP_SUBDIR as PROJECT_PATH for downstream https://github.com/timanovsky/subdir-heroku-buildpack
export PROJECT_PATH="$(cat $ENV_DIR/APP_SUBDIR)"
APP_DIR="${BUILD_DIR}/${PROJECT_PATH}"

echo "=====> Rewriting package references in anticipation of downstream buildpack promoting $PROJECT_PATH to the app root"

# Copy app.json over to maintain review app configurations
if [[ -f "${BUILD_DIR}/app.json" ]]; then
  cp "${BUILD_DIR}/app.json" "${APP_DIR}/app.json"
  echo "Copied ${BUILD_DIR}/app.json to ${APP_DIR}/app.json successfully" | indent
fi

# Move teamshares_packages from ../ to ./ (from build dir)
if [[ -d "${BUILD_DIR}/teamshares_packages" ]]; then
  cp -r "${BUILD_DIR}/teamshares_packages" "${APP_DIR}/teamshares_packages"
  echo "Copied ${BUILD_DIR}/teamshares_packages to ${APP_DIR}/teamshares_packages successfully" | indent
else
  echo "MISSING teamshares_packages -- are you sure you're in the right repo?" | indent
  exit 1
fi

update_references () {
  echo "Updating references in $1..." | indent
  sed -i -e "s|../teamshares_packages|./teamshares_packages|g" "$1"
  echo "Updated references in $1 successfully" | indent
}

update_references "${APP_DIR}/Gemfile"       # gem "teamshares_rails", path: "../teamshares_packages/teamshares_rails"
update_references "${APP_DIR}/Gemfile.lock"  # remote: ../teamshares_packages/teamshares_rails
update_references "${APP_DIR}/package.json"  # "@teamshares/ui": "file:../teamshares_packages/ui",
